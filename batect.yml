containers:
  tfsec:
    image: aquasec/trivy:latest
    volumes:
      - local: .
        container: /code
    working_directory: /code

  golang:
    image: golang:latest
    volumes:
      - local: .
        container: /code
    working_directory: /code

tasks:
  security-scan:
    description: Runs 'tfsec' security scanner
    run:
      container: tfsec
      command: config /code

  build:
    description: Builds the binaries from this Go project
    shell: true
    shell_executable: sh
    run:
      container: golang
      command: env GOOS=linux GOARCH=amd64 go build -o "yapl" -buildvcs=false "./cmd/yapl"

  check-all:
    description: Runs all the code checks
    prerequisites:
      - build
      - security-scan
